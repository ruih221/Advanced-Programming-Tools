{% extends "base.html" %}

{% block head %}
<title>StreamShare! | Geoview</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.min.js"></script>
{% endblock %}

{% block additional_style %}
<style>
/* Always set the map height explicitly to define the size of the div
    * element that contains the map. */
#map {
    height: 100%;
}
/* Optional: Makes the sample page fill the window. */
html, body {
    height: 100%;
    margin: 0;
    padding-top: 28px;
    padding-bottom: 40px;
}
@media (max-width: 991px) {
html, body {
  height: 100%;
  margin: 0;
  padding-top: 108px;
  padding-bottom: 40px;
}

@media (max-width: 432px) {
html, body {
  height: 100%;
  margin: 0;
  padding-top: 135px;
  padding-bottom: 40px;
}
}
</style>
{% endblock %}

{% block map %}
<div id="map"></div>
<div class = "container-fluid" id = "main_content">
  <div class = "mx-5 mt-2">
    <div id="slider-range"></div>
    <p>
      <label for='amount'>Pick a Date Range:</label>
      <input type="text" id="amount" readonly style="border: 0; color: #f6931f; font-weight: bold;" size="100">
    </p>
  </div>
</div>
  <script>
  
  </script>
    <script>
      
      var map;
      var markers = [];
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 3,
          center: {lat: 30.288917, lng: -97.735364}
        });

        markers = locations.map(function(location, i) {
          return new google.maps.Marker({
            position: location
          })
        });

        var infowindows = imgUrl.map(function(url, i) {
          var contentString ='<div><img src='+url+' width="100" height="100"></div>'
          return new google.maps.InfoWindow({
            content: contentString
          })
        });
        
        markers.forEach(function(marker, i) {
          marker.addListener('click', function(){
            infowindows[i].open(map, marker);
          });
        });
        
        var markerCluster = new MarkerClusterer(map, markers,
            {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
      }

      var locations = [];
      var imgUrl = [];
      var imgTime = [];

      $.ajax({
        type : "GET",
        url: "/getGeoData?streamid={{streamid}}",
        async : false,
        success: function(data) {
            data.imgLoc.forEach(
              function(loc) {
                  locations.push({lat: parseFloat(loc[0]), lng: parseFloat(loc[1])});
              }
            );
            data.imgUrl.forEach(
              function(url) {
                  imgUrl.push(url);
              }
            );
            data.imgTime.forEach(
              function(t) {
                  imgTime.push(t);
              }
            );
          },
          dataType: "json"
      });
      
      var today = new Date();;
      var then = new Date(new Date().setFullYear(new Date().getFullYear() - 1));

      jsTime = []
      imgTime.forEach(function(time) {
        jsTime.push(new Date(time));
      });
      function updateMap(low, high) {
        markers.forEach(function(mark, i) {
          if (jsTime[i] < low || jsTime[i] > high)
            mark.setMap(null);
          else
            mark.setMap(map);
        });
      };
      $(function() {
        $("#slider-range").slider({
          range: true,
          min: then.getTime() / 1000,
          max: today.getTime() / 1000,
          values: [then.getTime() / 1000, today.getTime() / 1000],
          slide: function(event, ui) {
              low = new Date(ui.values[0] * 1000);
              high = new Date(ui.values[1] * 1000);
              $("#amount").val(low.toDateString() + " - " +
                                    high.toDateString());
              updateMap(low, high);
            }
          });
          $("#amount").val((new Date($("#slider-range").slider("values", 0)*1000).toDateString()) +
            " - " + (new Date($("#slider-range").slider("values", 1)*1000)).toDateString());
      });
    </script>

    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB6J_0iBhjvMY56dvU-L11-X11nJXyA59A&callback=initMap">
    </script>

{% endblock %}
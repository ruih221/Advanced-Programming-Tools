{% extends "base.html" %}

{% block head %}
<script src="/static/js/dropzone.js" type="text/javascript"></script>
<script>
    var marker = {{imageUrls|length}}
    $(function() {
        $("#more-image").click(
            function(){
                $.ajax({
                    type: "GET",
                    url: '/loadMore?streamid={{streamId}}&marker='+marker,
                    success: function(data) {
                        data.images.forEach(
                            function(img) {
                                $("#img-pane").append('<div class="col-lg-3 col-md-4 col-6"><a href=' + img
                                    + ' class="d-block mb-4 h-100"><img class="img-fluid img-thumbnail" src='
                                    + img + ' alt=""></a></div>');
                            }
                            )
                            if (data.images.length != 0) {
                                marker += 4;
                            }
                        },
                        dataType: "json"
                    })
                }
                )
            })
            
    {% if isOwner %}
        Dropzone.options.mydrop = {
            autoProcessQueue: false,
            paramName: "file",
            addRemoveLinks: true,
            dictRemoveFile: "x",
            maxFilesize: 4,
            parallelUploads: 10,
            acceptedFiles: "image/*",

            init: function() {
                var submitButton = document.querySelector("#submit-image");
                myDropzone = this;

                submitButton.addEventListener("click", function() {
                    myDropzone.processQueue(); // Tell Dropzone to process all queued files.
                });
                
                myDropzone.on("complete", function() {
                    if (myDropzone.getUploadingFiles().length == 0 &&
                        myDropzone.getQueuedFiles().length == 0) {
                            setTimeout(function () {
                                window.location.reload();
                            }, 100);
                        }
                });
                
            }
        }
    {% endif %}
        </script>
    {% if isOwner %}
    <link type="text/css" rel="stylesheet" href="/static/css/dropzone.css">
    {% endif %}
    <!-- [START css] -->
    <style type="text/css">
            .dz-remove
            {
                display:inline-block !important;
                width:1.2em;
                height:1.2em;
                
                position:absolute;
                top:5px;
                right:5px;
                z-index:1000;
                
                font-size:1.2em !important;
                line-height:1em;
                
                text-align:center;
                font-weight:bold;
                border:1px solid gray !important;
                border-radius:1.2em;
                color:rgb(250, 16, 16);
                background-color:white;
                opacity:.5;
            }
            
            .dz-remove:hover
            {
                text-decoration:none !important;
                opacity:1;
            }
            
            img 
            {
                max-height : 300px;
            }
            
        </style>
    <!-- [END css] -->
{% endblock %}

{% block content %}
<div class = 'mx-5'>
    <h1>{{streamId}}</h1>
    <div id = "img-pane" class = "row text-center text-lg-left">
    {% for image in imageUrls %}
        <div class="col-lg-3 col-md-4 col-6">
            <a href="{{image}}" class="d-block mb-4 h-100">
                    <img class="img-fluid img-thumbnail" src={{image}} alt="">
            </a>
        </div>
    {% endfor %}
    </div>

    <button type="button" class="btn btn-primary my-3" id="more-image">More</button>
    
    {% if isOwner %}
    <form action="/uploadImage?streamid={{streamId}}"
            class="dropzone"
            id="mydrop">
    </form>
    <button class="btn btn-primary my-3" id="submit-image">Submit</button>
    {% elif not isSub %}
    <form action='/addsub' method = 'post'>
        <button name="subscribe" class="btn btn-primary" value={{streamId}} type="submit">Subscribe</button>
    </form>
    {% else %}
    <form action='/removesub?single=true' method ='post'>
        <button name="unsubscribe" class="btn btn-primary" value={{streamId}} type="submit">Unsubscribe</button>
    </form>
    {% endif %}
</div>
{% endblock %}